{% block result %}
<div class="gallery">
    {% for photo in photos %}
    <div class="photo-wrapper">
        <img style="width: 100%;" src="{{ photo['urls']['small'] }}" alt="">
        <p>Photo by: <a target="_blank" href="{{ photo['user']['links']['html'] }}">{{ photo['user']['username'] }}</a> on <a target="_blank" href="https://unsplash.com/">Unsplash</a></p>

        <form action="{{ url_for('unsplash.download', id=photo['id']) }}" method="post">
            {{ form.csrf_token }}
            {{ form.user(value=photo['user']['username']) }}
            {{ form.user_url(value=photo['user']['links']['html']) }}
            {{ form.url(value=photo['links']['download']) }}

            {{ form.submit(value='Download', class='btn btn-primary') }}
            <button style="display: none;" class="btn-loading btn btn-primary" type="button" disabled>
                <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                Downloading...
            </button>
        </form>
    </div>
    {% endfor %}
</div>
<script>
    $(document).ready(function() {
        var photos = document.querySelectorAll('.photo-wrapper');
    
        photos.forEach(photo => {
            var form = photo.getElementsByTagName('form');
            
            submit(form);
        });
    });

    function submit(form) {
        $(form).submit(function(e) {
            e.preventDefault();

            var form = $(this);
            var url = form.attr('action');

            var submit = $('input[type=submit]', this);
            var loading = form.find('.btn-loading');
            
            $.ajax({
                type: 'POST',
                url: url,
                data: form.serialize(),
                beforeSend: function() {
                    submit.prop('disabled', true);
                    submit.hide();
                    loading.show();
                },
                complete: function() {
                    loading.hide();
                    submit.show();
                },
                success: function(data) {
                    alert(data); // TODO: change to toast
                }
            });
        });
    }
</script>
{% endblock %}